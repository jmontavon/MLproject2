### MLproject2
Project for the EPFL Machine Learning course done in the scope of ML4Science.

## Installation of Python Env

First install the environment project-env
`python3 -m venv project-env` 

Connect yourself to this newly created env
`source project-env/bin/activate`

Then install all requirements : 
`pip install -r utils/requirements.txt`

Enjoy !

Tested on MACOSX Catalina. Tensorflow-GPU for DELTA was not tested. 

## Description of the methods used

Hereafter we aimed at giving a step-by-step README to be able to build training set, train the models, get predictions and analyse predictions in a chronological order. We start with all processes linked with segmentation, continue with cell tracking and finish with inference of theta transition matrix.

The script and notebook in the folders were partly coded by ourselves  (notebook beginning with `PROJECT_`) or script part of the software DELTA (scripts starting with suffix `DELTA_`). 

# Cell segmentation

## Segmentation training with DELTA 
 
All the path to the training dataset folder and to the model file are in config.py. All the path should be correct. It needs the folder data/ to be in the root of the project folder.

To generate the training set, we first rely on manual annotation with program NAPARI (not shown here). This training allowed to build the .tif object `data/ground_truth/segmentation/training_set_curated.tif` which correspond to position [0:512,0:512], for every frames in the full movie `data/_fullmovie_images.tif` and `data/_fullmovie_segmentation.tif`. All the process to get from the manual annotation to the training set are in the following notebook, with illustration of the custom weights : 

`jupyter notebook PROJECT_gen_segmentation_training.ipynb`

To launch segmentation training : 

`python3 DELTA_train_segmentation.py` i

WARNING : the training above can take up to 48 hours to run ! Although, the first models are written in less than 5 minutes. Also be careful because this training will erase the models in data/models. To use the fully trained models, you might have to download the folder data/ again after this step.

## Segmentation prediction with DELTA 

To launch the prediction of cell segmentation with DELTA with trained models, the following command can be launched : 

`python3 DELTA_segmentation.py` 

The model that is used is defined in `config.py`. The input/output are specific in the script `DELTA_segmentation.py` itself. The output will be written in `testing_curated_seg_1/seg_out_new`  

### Post-processing and analysis of segmentation predictions : 

We then assemble segmentation predictions, analyze them and compare them with ilastik predictions in the following notebook : 

`jupyter notebook PROJECT_proc_seg_pred.ipynb`

## Segmentation with ILASTIK

To be able to compare our segmentation accuracy with another method, we used the user interface ilastik to generate segmentations. 

Notebook 'PROJECT_ilastik_segmentation.ipynb' has to be followed to generate 'video1.tiff' and 'video2.tiff', that will be used in order to create the segmentation in Ilastik graphical user interface. The first video is the training set, the second the test set. The files generated by ILASTIK are called 'seg_nonbinary_test.tiff' and 'seg_nonbinary_train.tiff' and need to be processed. They illustate the segmentation with the boundary of the cell, the interior of the cell as well as its kernel. The Jupyter notebook then processes these files, smooth them, and create binary image sequences 'ilastik_train.tiff' and 'lastik_test.tiff'.

# Cell tracking 

## training with DELTA

The training set of cell tracking was manually annotated on NAPARI to get ground truth cell tracking. We saved manually recorded annotations in `data/ground_truth/tracking/_cell_tracking_manual_annotations.tif` file, and process these annotations in the following notebook to build a Delta-compatible training set : 
`jupyter notebook PROJECT_gen_tracking_training.ipynb` 

To launch cell tracking training : 

` python3 DELTA_train_tracking.py`

WARNING : the training above can take up to 12 hours to run ! Although, the first models are written in less than 5 minutes. Also be careful because this training will erase the models in data/models. To use the fully trained models, you might have to download the folder data/ again after this step.

## Cell tracking predictions with DELTA

To launch the prediction of cell tracking with DELTA, simply launch :  

`python3 DELTA_tracking.py`

The model used is described in `config.py`. The intput/output are specified in the script DELTA_tracking.py script itself. 

### Post-processing and analysis of cell tracking predictions 

We then analysed cell tracking predictions and compared them to another ground truth we made, `data/ground_truth/tracking_ground_truth_0_512_0_512.tif`, to compute prediction accuracy, in the following notebook : 

`jupyter notebook PROJECT_proc_cell_track.ipynb`


# Simulation and EM algorithm for transition matrix
To launch the simulation of the cell division and the EM algorithm for the transition matrix, simply launch:

`jupyter notebook PROJECT_simulation_EMalgoritm.ipynb`

